---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kutt-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: kutt
  template:
    metadata:
      labels:
        app: kutt
    spec:
      imagePullSecrets:
        - name: github-registry-secret
      containers:
      - name: web
        image: kutt/kutt
        ports:
        - containerPort: 3000
          protocol: TCP
        command: ["node"]
        args: ["production-server/server.js"]
        env:
        - name: ADMIN_EMAILS
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: admin-emails
        - name: CONTACT_EMAIL
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: contact-email
        - name: CUSTOM_DOMAIN_USE_HTTPS
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: domain-https
        - name: DEFAULT_DOMAIN
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: domain
        - name: DISALLOW_ANONYMOUS_LINKS
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: disallow-anonymous
        - name: DISALLOW_DOMAIN
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: disallow-domain
        - name: DISALLOW_REGISTRATION
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: disallow-reg
        - name: LINK_LENGTH
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: link-length
        - name: MAIL_PORT
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: mail-port
        - name: MAIL_SECURE
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: mail-secure
        - name: NODE_ENV
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: node-env
        - name: REPORT_EMAIL
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: report-email
        - name: SITE_NAME
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: site-name
        - name: USER_LIMIT_PER_DAY
          valueFrom:
            configMapKeyRef:
              name: kutt-config
              key: user-limit
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: db-host
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: db-name
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: db-user
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: db-password
        - name: GOOGLE_SAFE_BROWSING_KEY
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: safe-browsing-key
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: jwt-secret
        - name: MAIL_HOST
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: mail-host
        - name: MAIL_HOST
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: mail-host
        - name: MAIL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: mail-password
        - name: MAIL_USER
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: mail-user
        - name: RECAPTCHA_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: recaptcha-secret-key
        - name: RECAPTCHA_SITE_KEY
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: recaptcha-site-key
        - name: REDIS_HOST
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: redis-host
        - name: SENTRY_PRIVATE_DSN
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: sentry-private-dsn
        - name: SENTRY_PUBLIC_DSN
          valueFrom:
            secretKeyRef:
              name: kutt-secrets
              key: sentry-public-dsn